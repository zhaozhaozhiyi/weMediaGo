name: Build Executables

on:
  push:
    tags:
      - 'v*'  # 推送版本标签时触发
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web_app/package-lock.json

      - name: Install system dependencies (macOS)
        run: |
          brew install libpng jpeg libtiff

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download model file
        run: |
          mkdir -p models/lama
          echo "📥 下载 LaMa 模型文件..."
          curl -L -o models/lama/big-lama.pt \
            https://github.com/Sanster/models/releases/download/add_big_lama/big-lama.pt
          
          # 验证文件大小（大约 196MB）
          FILE_SIZE=$(stat -f%z models/lama/big-lama.pt)
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          echo "✅ 模型文件已下载: ${FILE_SIZE_MB} MB"
          
          # 验证文件是否存在
          if [ ! -f "models/lama/big-lama.pt" ]; then
            echo "❌ 错误: 模型文件下载失败"
            exit 1
          fi

      - name: Build frontend
        working-directory: ./web_app
        run: |
          npm ci
          npm run build

      - name: Copy frontend files
        run: |
          cp -r web_app/dist/* iopaint/web_app/

      - name: Build executable with PyInstaller
        run: |
          pyinstaller wemediago.spec --clean --noconfirm

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Package macOS app
        run: |
          cd dist
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Debug: List contents of dist directory
          echo "Contents of dist directory:"
          ls -la
          
          # macOS 应该生成 .app 文件
          if [ -d "WeMediaGo.app" ]; then
            zip -r "WeMediaGo-macos-${VERSION}.zip" WeMediaGo.app/
            echo "✅ 成功打包: WeMediaGo-macos-${VERSION}.zip"
          elif [ -d "wemediago.app" ]; then
            # 兼容旧名称
            zip -r "WeMediaGo-macos-${VERSION}.zip" wemediago.app/
            echo "✅ 成功打包: WeMediaGo-macos-${VERSION}.zip"
          else
            echo "❌ 错误: 未找到 .app 文件"
            ls -la
            exit 1
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: WeMediaGo-macos
          path: dist/WeMediaGo-macos-*.zip
          retention-days: 30

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web_app/package-lock.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download model file
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "models\lama" | Out-Null
          Write-Host "📥 下载 LaMa 模型文件..."
          Invoke-WebRequest -Uri "https://github.com/Sanster/models/releases/download/add_big_lama/big-lama.pt" `
            -OutFile "models\lama\big-lama.pt"
          
          # 验证文件大小
          $FileSize = (Get-Item "models\lama\big-lama.pt").Length / 1MB
          Write-Host "✅ 模型文件已下载: $([math]::Round($FileSize, 2)) MB"
          
          # 验证文件是否存在
          if (-not (Test-Path "models\lama\big-lama.pt")) {
            Write-Error "❌ 错误: 模型文件下载失败"
            exit 1
          }

      - name: Build frontend
        working-directory: ./web_app
        run: |
          npm ci
          npm run build

      - name: Copy frontend files
        shell: powershell
        run: |
          Copy-Item -Path "web_app\dist\*" -Destination "iopaint\web_app\" -Recurse -Force

      - name: Build executable with PyInstaller
        run: |
          pyinstaller wemediago.spec --clean --noconfirm

      - name: Get version
        id: get_version
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")
          }
          Write-Output "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Output "Version: $VERSION"

      - name: Package Windows executable
        shell: powershell
        run: |
          cd dist
          $VERSION = "${{ steps.get_version.outputs.version }}"
          
          Write-Host "检查构建产物..."
          Get-ChildItem
          
          # Windows 应该生成 .exe 文件或目录
          if (Test-Path "WeMediaGo.exe") {
            # 单个 .exe 文件（所有文件打包在一起）
            Compress-Archive -Path "WeMediaGo.exe" -DestinationPath "WeMediaGo-windows-${VERSION}.zip" -Force
            Write-Host "✅ 成功打包: WeMediaGo-windows-${VERSION}.zip"
          } elseif (Test-Path "WeMediaGo\WeMediaGo.exe") {
            # .exe 在子目录中
            Compress-Archive -Path "WeMediaGo\*" -DestinationPath "WeMediaGo-windows-${VERSION}.zip" -Force
            Write-Host "✅ 成功打包: WeMediaGo-windows-${VERSION}.zip"
          } elseif (Test-Path "wemediago.exe") {
            Compress-Archive -Path "wemediago.exe" -DestinationPath "WeMediaGo-windows-${VERSION}.zip" -Force
            Write-Host "✅ 成功打包: WeMediaGo-windows-${VERSION}.zip"
          } else {
            Write-Error "❌ 错误: 未找到 .exe 文件"
            Get-ChildItem -Recurse
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: WeMediaGo-windows
          path: dist/WeMediaGo-windows-*.zip
          retention-days: 30

  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: get_version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/WeMediaGo-macos/*
            artifacts/WeMediaGo-windows/*
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## WeMediaGo ${{ steps.get_version.outputs.version }}
            
            ### 📦 安装包
            
            - **macOS**: `WeMediaGo-macos-*.zip` - 解压后双击 `WeMediaGo.app` 运行
            - **Windows**: `WeMediaGo-windows-*.zip` - 解压后双击 `WeMediaGo.exe` 运行
            
            ### ✨ 功能
            
            - ✅ 模型文件已内置，无需下载
            - ✅ 开箱即用，双击运行
            - ✅ 支持图片、视频、音频处理
            
            ### 📝 使用说明
            
            1. 下载对应平台的安装包
            2. 解压文件
            3. 双击运行应用
            
            > 注意：首次运行可能需要一些时间加载模型
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
